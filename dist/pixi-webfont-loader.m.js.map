{"version":3,"file":"pixi-webfont-loader.m.js","sources":["../src/pixi-webfont-loader.ts"],"sourcesContent":["import { LoaderResource, ILoaderPlugin } from 'pixi.js';\nimport * as FontFaceObserver from 'fontfaceobserver';\n\nexport default class WebfontLoaderPlugin implements ILoaderPlugin\n{\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    static add(..._params: any[]): any\n    {\n        LoaderResource.setExtensionLoadType('css', LoaderResource.LOAD_TYPE.XHR);\n        LoaderResource.setExtensionXhrType('css', LoaderResource.XHR_RESPONSE_TYPE.TEXT);\n    }\n    static use(resource: LoaderResource, next: (...params: any[]) => any): void\n    {\n        if (resource.extension !== 'css')\n        {\n            next();\n\n            return;\n        }\n\n        // create the CSS link\n        const newLink = document.createElement('link');\n\n        newLink.rel = 'stylesheet';\n        newLink.type = 'text/css';\n        newLink.href = resource.url;\n\n        // append to head\n        document.head.appendChild(newLink);\n\n        // parse the css\n        const allFonts = WebfontLoaderPlugin.parseCss(resource.data);\n\n        // make the outputs\n        const promiseArr = [];\n        const fontDefinitionArr = [];\n\n        // my bundler can't do conditional chaining and I don't know why\n        const metadata = resource.metadata;\n        const testString = metadata === null || metadata === undefined ? undefined : metadata.testString;\n        const timeout = metadata === null || metadata === undefined ? undefined : metadata.timeout;\n\n        for (const font of allFonts)\n        {\n            if (typeof font.style['font-family'] === 'string')\n            {\n                // add watchface promises\n                promiseArr.push(\n                    new FontFaceObserver(font.style['font-family'].replace(/['|\"]/gi, ''), {\n                        style: font.style['font-style'],\n                        weight: font.style['font-weight'],\n                        stretch: font.style['font-stretch'],\n                    }).load(testString, timeout),\n                );\n\n                // make the loaded font data for later user reference\n                fontDefinitionArr.push({\n                    fontFamily: font.style['font-family'].replace(/['|\"]/gi, ''),\n                    fontStyle: font.style['font-style'],\n                    fontWeight: font.style['font-weight'],\n                    // fontStretch: font.style[\"font-stretch\"], //pixi doesn't know this\n                });\n            }\n        }\n\n        // store the fonts that we loaded\n        resource.data = fontDefinitionArr;\n\n        // wait for all fonts to be ready\n        // use finally because loaders in pixi ALWAYS end. Even on catastrophic failures.\n        Promise.all(promiseArr).finally(() => next());\n    }\n\n    /**\tParse a CSS StyleSheet into an Array of CSSStyleRule objects,\n\t *\teach having normalized `selectorText` and `style` properties.\n\t *\tHardcore regex stolen from: https://jsfiddle.net/developit/vzkckrw4/\n\t *\t@param {String} stylesheet\n\t *\t@returns {Array(CSSStyleRule)}\n\t */\n    private static parseCss(text: string): { selectorText: string; style: any; cssText: string }[]\n    {\n        const tokenizer = /([\\s\\S]+?)\\{([\\s\\S]*?)\\}/gi;\n        const rules = [];\n        let rule;\n        let token;\n\n        text = text.replace(/\\/\\*[\\s\\S]*?\\*\\//g, '');\n        while ((token = tokenizer.exec(text)))\n        {\n            const style = WebfontLoaderPlugin.parseRule(token[2].trim());\n\n            style.cssText = WebfontLoaderPlugin.stringifyRule(style);\n            rule = {\n                selectorText: token[1].trim().replace(/\\s*\\,\\s*/, ', '),\n                style,\n                cssText: '',\n            };\n            rule.cssText = `${rule.selectorText} { ${rule.style.cssText as string} }`;\n            rules.push(rule);\n        }\n\n        return rules;\n    }\n\n    private static parseRule(css: string): any\n    {\n        const tokenizer = /\\s*([a-z\\-]+)\\s*:\\s*((?:[^;]*url\\(.*?\\)[^;]*|[^;]*)*)\\s*(?:;|$)/gi;\n        const obj: any = {};\n        let token;\n\n        while ((token = tokenizer.exec(css)))\n        {\n            obj[token[1].toLowerCase()] = token[2];\n        }\n\n        return obj;\n    }\n\n    private static stringifyRule(style: any): string\n    {\n        let text = '';\n        const keys = Object.keys(style).sort();\n\n        for (let i = 0; i < keys.length; i++)\n        {\n            text += ` ${keys[i]}: ${style[keys[i]] as string};`;\n        }\n\n        return text.substring(1);\n    }\n}\n"],"names":["WebfontLoaderPlugin","add","LoaderResource","setExtensionLoadType","LOAD_TYPE","XHR","setExtensionXhrType","XHR_RESPONSE_TYPE","TEXT","use","resource","next","extension","newLink","document","createElement","rel","type","href","url","head","appendChild","allFonts","parseCss","data","promiseArr","fontDefinitionArr","metadata","testString","undefined","timeout","font","style","push","FontFaceObserver","replace","weight","stretch","load","fontFamily","fontStyle","fontWeight","Promise","all","text","rule","token","tokenizer","rules","exec","parseRule","trim","cssText","stringifyRule","selectorText","css","obj","toLowerCase","keys","Object","sort","i","length","substring"],"mappings":"sLAGqBA,IAAAA,oCAGVC,IAAP,WAEIC,EAAeC,qBAAqB,MAAOD,EAAeE,UAAUC,KACpEH,EAAeI,oBAAoB,MAAOJ,EAAeK,kBAAkBC,SAExEC,IAAP,SAAWC,EAA0BC,GAEjC,GAA2B,QAAvBD,EAASE,UAAb,CAQA,IAAMC,EAAUC,SAASC,cAAc,QAEvCF,EAAQG,IAAM,aACdH,EAAQI,KAAO,WACfJ,EAAQK,KAAOR,EAASS,IAGxBL,SAASM,KAAKC,YAAYR,GAc1B,IAXA,MAAMS,EAAWtB,EAAoBuB,SAASb,EAASc,MAGjDC,EAAa,GACbC,EAAoB,GAGpBC,EAAWjB,EAASiB,SACpBC,EAAaD,MAAAA,OAA8CE,EAAYF,EAASC,WAChFE,EAAUH,MAAAA,OAA8CE,EAAYF,EAASG,6rBAEhER,kBACnB,KADWS,UAEkC,iBAA9BA,EAAKC,MAAM,iBAGlBP,EAAWQ,KACP,IAAIC,EAAiBH,EAAKC,MAAM,eAAeG,QAAQ,UAAW,IAAK,CACnEH,MAAOD,EAAKC,MAAM,cAClBI,OAAQL,EAAKC,MAAM,eACnBK,QAASN,EAAKC,MAAM,kBACrBM,KAAKV,EAAYE,IAIxBJ,EAAkBO,KAAK,CACnBM,WAAYR,EAAKC,MAAM,eAAeG,QAAQ,UAAW,IACzDK,UAAWT,EAAKC,MAAM,cACtBS,WAAYV,EAAKC,MAAM,kBAOnCtB,EAASc,KAAOE,EAIhBgB,QAAQC,IAAIlB,WAAoB,kBAAMd,WAvDlCA,OAgEOY,SAAP,SAAgBqB,GAEpB,IAEIC,EACAC,EAHEC,EAAY,6BACZC,EAAQ,GAKd,IADAJ,EAAOA,EAAKT,QAAQ,oBAAqB,IACjCW,EAAQC,EAAUE,KAAKL,IAC/B,CACI,IAAMZ,EAAQhC,EAAoBkD,UAAUJ,EAAM,GAAGK,QAErDnB,EAAMoB,QAAUpD,EAAoBqD,cAAcrB,IAClDa,EAAO,CACHS,aAAcR,EAAM,GAAGK,OAAOhB,QAAQ,WAAY,MAClDH,MAAAA,EACAoB,QAAS,KAERA,QAAaP,EAAKS,mBAAkBT,EAAKb,MAAMoB,aACpDJ,EAAMf,KAAKY,GAGf,OAAOG,KAGIE,UAAP,SAAiBK,GAMrB,IAJA,IAEIT,EAFEC,EAAY,oEACZS,EAAW,GAGTV,EAAQC,EAAUE,KAAKM,IAE3BC,EAAIV,EAAM,GAAGW,eAAiBX,EAAM,GAGxC,OAAOU,KAGIH,cAAP,SAAqBrB,GAKzB,IAHA,IAAIY,EAAO,GACLc,EAAOC,OAAOD,KAAK1B,GAAO4B,OAEvBC,EAAI,EAAGA,EAAIH,EAAKI,OAAQD,IAE7BjB,OAAYc,EAAKG,QAAO7B,EAAM0B,EAAKG,QAGvC,OAAOjB,EAAKmB,UAAU"}